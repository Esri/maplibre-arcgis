/* @esri/maplibre-arcgis - v1.0.1 - Mon Dec 08 2025 15:03:12 GMT-0800 (Pacific Standard Time)
 * Copyright (c) 2025 Environmental Systems Research Institute, Inc.
 * Apache-2.0 */
import nt from"maplibre-gl";var ae='Powered by <a href="https://www.esri.com/">Esri</a>',ke='<a href="https://maplibre.org/">MapLibre</a>',st='<a href="https://maplibre.org/" target="_blank">MapLibre</a>',at={customAttribution:`${ke} | ${ae}`,compact:!0},H=class r extends nt.AttributionControl{constructor(e={}){!e?.compact&&e?.collapsed&&(e.compact=!0);let t=[];e.customAttribution&&(Array.isArray(e.customAttribution)?t.concat(e.customAttribution.map(o=>typeof o!="string"?"":o)):typeof e.customAttribution=="string"&&t.push(e.customAttribution)),t.push(ae,ke);let i={compact:e?.compact!==void 0?e.compact:!0,customAttribution:t.join(" | ")};super(i),this.attributionOptions=i,this._closed=e?.collapsed}onAdd(e){if(this._map=e,!this.canAdd(this._map))return console.warn("Esri attribution already present on map. This attribution control will not be added."),null;let t=super.onAdd(e);return this._closed&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show"),t}canAdd(e){if(!e&&!this._map)throw new Error("No map provided to attribution control.");e||(e=this._map);let t=!1;return e._controls.length>0&&e._controls.forEach(i=>{if("_toggleAttribution"in i){let o=i;if(o.options.customAttribution===st)e.removeControl(o);else if(o.options.customAttribution.includes(ae))t=!0;else{let n="Unable to load Esri attribution. Set the attributionControl property of BasemapStyle to display custom attribution.";throw new Error(n)}}}),!t}static get esriAttribution(){return new r().attributionOptions}},Re=H;function D(r){return{all:r=r||new Map,on:function(e,t){var i=r.get(e);i?i.push(t):r.set(e,[t])},off:function(e,t){var i=r.get(e);i&&(t?i.splice(i.indexOf(t)>>>0,1):r.set(e,[]))},emit:function(e,t){var i=r.get(e);i&&i.slice().map(function(o){o(t)}),(i=r.get("*"))&&i.slice().map(function(o){o(e,t)})}}}function Ae(r,e){var t={};for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&e.indexOf(i)<0&&(t[i]=r[i]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var o=0,i=Object.getOwnPropertySymbols(r);o<i.length;o++)e.indexOf(i[o])<0&&Object.prototype.propertyIsEnumerable.call(r,i[o])&&(t[i[o]]=r[i[o]]);return t}function q(r){return Object.keys(r).some(e=>{let t=r[e];if(!t)return!1;switch(t&&t.toParam&&(t=t.toParam()),t.constructor.name){case"Array":return!1;case"Object":return!1;case"Date":return!1;case"Function":return!1;case"Boolean":return!1;case"String":return!1;case"Number":return!1;default:return!0}})}function ee(r){let e={};return Object.keys(r).forEach(t=>{var i,o;let n=r[t];if(n&&n.toParam&&(n=n.toParam()),!n&&n!==0&&typeof n!="boolean"&&typeof n!="string")return;let s=n.constructor.name,c;switch(s){case"Array":let l=(o=(i=n[0])===null||i===void 0?void 0:i.constructor)===null||o===void 0?void 0:o.name;c=l==="Array"?n:l==="Object"?JSON.stringify(n):n.join(",");break;case"Object":c=JSON.stringify(n);break;case"Date":c=n.valueOf();break;case"Function":c=null;break;case"Boolean":c=n+"";break;default:c=n;break}(c||c===0||typeof c=="string"||Array.isArray(c))&&(e[t]=c)}),e}function Ue(r,e){return Array.isArray(e)&&e[0]&&Array.isArray(e[0])?e.map(t=>Ue(r,t)).join("&"):encodeURIComponent(r)+"="+encodeURIComponent(e)}function A(r){let e=ee(r);return Object.keys(e).map(t=>Ue(t,e[t])).join("&")}var $e=globalThis.FormData,Dt=globalThis.File,Mt=globalThis.Blob;function Ce(r,e){let t=q(r)||e,i=ee(r);if(t){let o=new $e;return Object.keys(i).forEach(n=>{if(typeof Blob<"u"&&i[n]instanceof Blob){let s=i.fileName||i[n].name||n;o.append(n,i[n],s)}else o.append(n,i[n])}),o}else return A(r)}var k=class extends Error{constructor(e,t,i,o,n){super(e);let s=new.target.prototype;Object.setPrototypeOf(this,s),e=e||"UNKNOWN_ERROR",t=t||"UNKNOWN_ERROR_CODE",this.name="ArcGISRequestError",this.message=t==="UNKNOWN_ERROR_CODE"?e:`${t}: ${e}`,this.originalMessage=e,this.code=t,this.response=i,this.url=o,this.options=n}};var ct={noCorsDomains:[],crossOriginNoCorsDomains:{},pendingNoCorsRequests:{}},ce="ARCGIS_REST_JS_NO_CORS";globalThis[ce]||(globalThis[ce]=Object.assign({},ct));var w=globalThis[ce];function Pe(r){let e=new URL(r);r=e.origin+e.pathname,e.search.includes("f=json")&&(r+="?f=json");let t=e.origin;return w.pendingNoCorsRequests[t]?w.pendingNoCorsRequests[t]:(w.pendingNoCorsRequests[t]=fetch(r,{mode:"no-cors",credentials:"include",cache:"no-store"}).then(i=>{w.noCorsDomains.indexOf(t)===-1&&w.noCorsDomains.push(t),w.crossOriginNoCorsDomains[t.toLowerCase()]=Date.now(),delete w.pendingNoCorsRequests[t]}).catch(i=>(delete w.pendingNoCorsRequests[t],Promise.reject(new Error(`no-cors request to ${t} failed`)))),w.pendingNoCorsRequests[t])}function je(r){r.forEach(e=>{e=e.toLowerCase(),/^https?:\/\//.test(e)?le(e):(le("http://"+e),le("https://"+e))})}function le(r){let t=new URL(r).origin;w.noCorsDomains.indexOf(t)===-1&&w.noCorsDomains.push(t)}function ue(r){let e=!1;if(w.noCorsDomains.length){let t=new URL(r).origin.toLowerCase();e=w.noCorsDomains.some(i=>t.includes(i))}return e}function De(r){let e=!1;if(ue(r)){let t=new URL(r).origin.toLowerCase(),i=w.crossOriginNoCorsDomains[t]||0;Date.now()-60*6e4>i&&(e=!0)}return e}function pe(r){console&&console.warn&&console.warn.apply(console,[r])}function Me(){return Promise.resolve({fetch:globalThis.fetch,Headers:globalThis.Headers,Response:globalThis.Response,Request:globalThis.Request})}function Fe(r,e){var t;if(!e&&!window||!r)return!1;{e=e||window;let i=(t=e.location)===null||t===void 0?void 0:t.origin;return r.startsWith(i)}}var me="@esri/arcgis-rest-js";function lt(){return globalThis.DEFAULT_ARCGIS_REQUEST_OPTIONS||{httpMethod:"POST",params:{f:"json"}}}var M=class extends k{constructor(e="AUTHENTICATION_ERROR",t="AUTHENTICATION_ERROR_CODE",i,o,n){super(e,t,i,o,n),this.name="ArcGISAuthError",this.message=t==="AUTHENTICATION_ERROR_CODE"?e:`${t}: ${e}`;let s=new.target.prototype;Object.setPrototypeOf(this,s)}retry(e,t=1){let i=0,o=(n,s)=>{i=i+1,e(this.url,this.options).then(c=>{let l=Object.assign(Object.assign({},this.options),{authentication:c});return Ne(this.url,l)}).then(c=>{n(c)}).catch(c=>{c.name==="ArcGISAuthError"&&i<t?o(n,s):c.name===this.name&&c.message===this.message&&i>=t?s(this):s(c)})};return new Promise((n,s)=>{o(n,s)})}};function ut(r,e,t,i,o){if(r.code>=400){let{message:n,code:s}=r;throw new k(n,s,r,e,i)}if(r.error){let{message:n,code:s,messageCode:c}=r.error,l=c||s||"UNKNOWN_ERROR_CODE";throw s===498||s===499?o||new M(n,l,r,e,i):new k(n,l,r,e,i)}if(r.status==="failed"||r.status==="failure"){let n,s="UNKNOWN_ERROR_CODE";try{n=JSON.parse(r.statusMessage).message,s=JSON.parse(r.statusMessage).code}catch{n=r.statusMessage||r.message}throw new k(n,s,r,e,i)}return r}function Ne(r,e){let t=lt(),i=Object.assign(Object.assign(Object.assign({httpMethod:"POST"},t),e),{params:Object.assign(Object.assign({},t.params),e.params),headers:Object.assign(Object.assign({},t.headers),e.headers)}),{httpMethod:o,rawResponse:n}=i,s=Object.assign({f:"json"},i.params),c=null,l={method:o,signal:i.signal,credentials:i.credentials||"same-origin"};ue(r)&&(l.credentials="include"),i.headers&&i.headers["X-Esri-Auth-Client-Id"]&&r.indexOf("/oauth2/platformSelf")>-1&&(l.credentials="include");let h;if(typeof i.authentication=="string"){let u=i.authentication;h={portal:"https://www.arcgis.com/sharing/rest",getToken:()=>Promise.resolve(u)},!i.authentication.startsWith("AAPK")&&!i.authentication.startsWith("AATK")&&!i.suppressWarnings&&!globalThis.ARCGIS_REST_JS_SUPPRESS_TOKEN_WARNING&&(pe("Using an oAuth 2.0 access token directly in the token option is discouraged. Consider using ArcGISIdentityManager or Application session. See https://esriurl.com/arcgis-rest-js-direct-token-warning for more information."),globalThis.ARCGIS_REST_JS_SUPPRESS_TOKEN_WARNING=!0)}else h=i.authentication;let d=r,y=!1;typeof window<"u"&&(y=Fe(r));let b=!y&&De(r);i.headers&&i.headers["X-Esri-Auth-Client-Id"]&&r.indexOf("/oauth2/platformSelf")>-1&&(l.credentials="include");let R=Promise.resolve();return b&&(l.credentials="include",R=Pe(r)),R.then(()=>h?h.getToken(r).catch(u=>(u.url=r,u.options=i,c=u,Promise.resolve(""))):Promise.resolve("")).then(u=>{u.length&&(s.token=u),h&&h.getDomainCredentials&&(l.credentials=h.getDomainCredentials(r));let f={};if(l.method==="GET"){s.token&&i.hideToken&&typeof window>"u"&&(f["X-Esri-Authorization"]=`Bearer ${s.token}`,delete s.token);let T=A(s)===""?r:r+"?"+A(s);i.maxUrlLength&&T.length>i.maxUrlLength||!i.maxUrlLength&&T.length>2e3||s.token&&i.hideToken?(l.method="POST",u.length&&i.hideToken&&(s.token=u,delete f["X-Esri-Authorization"])):r=T}let x=new RegExp("/items/.+/updateResources").test(r);return l.method==="POST"&&(l.body=Ce(s,x)),l.headers=Object.assign(Object.assign({},f),i.headers),(typeof window>"u"||window&&typeof window.document>"u")&&!l.headers.referer&&(l.headers.referer=me),!q(s)&&!x&&(l.headers["Content-Type"]="application/x-www-form-urlencoded"),globalThis.fetch?globalThis.fetch(r,l):Me().then(({fetch:g})=>g(r,l))}).then(u=>{if(!u.ok)return u.json().then(f=>{let{status:x,statusText:g}=u,{message:T,details:B}=f.error,j=`${T}. ${B?B.join(" "):""}`.trim();throw new k(j,`HTTP ${x} ${g}`,f,r,i)}).catch(f=>{if(f.name==="ArcGISRequestError")throw f;let{status:x,statusText:g}=u;throw new k(g,`HTTP ${x}`,u,r,i)});if(n)return u;switch(s.f){case"json":return u.json();case"geojson":return u.json();case"html":return u.text();case"text":return u.text();default:return u.blob()}}).then(u=>{if((s.f==="json"||s.f==="geojson")&&!n){let f=ut(u,d,s,i,c);if(u&&/\/sharing\/rest\/(accounts|portals)\/self/i.test(r)&&Array.isArray(u.authorizedCrossOriginNoCorsDomains)&&je(u.authorizedCrossOriginNoCorsDomains),c){let x=r.toLowerCase().split(/\/rest(\/admin)?\/services\//)[0];i.authentication.federatedServers[x]={token:[],expires:new Date(Date.now()+86400*1e3)},c=null}return f}else return u})}function a(r,e={params:{f:"json"}}){let{request:t}=e,i=Ae(e,["request"]);return t?t(r,i):Ne(r,i).catch(o=>o instanceof M&&e.authentication&&typeof e.authentication!="string"&&e.authentication.canRefresh&&e.authentication.refreshCredentials?o.retry(()=>e.authentication.refreshCredentials(),1):Promise.reject(o))}function S(r,e,t){let i=["params","httpMethod","rawResponse","authentication","hideToken","portal","credentials","maxUrlLength","headers","signal","suppressWarnings","request"],o=Object.assign(Object.assign({params:{}},t),r);return o.params=e.reduce((n,s)=>((r[s]||typeof r[s]=="boolean"||typeof r[s]=="number"&&r[s]===0)&&(n[s]=r[s]),n),o.params),i.reduce((n,s)=>(o[s]&&(n[s]=o[s]),n),{})}var I;(function(r){r.TOKEN_REFRESH_FAILED="TOKEN_REFRESH_FAILED",r.GENERATE_TOKEN_FOR_SERVER_FAILED="GENERATE_TOKEN_FOR_SERVER_FAILED",r.REFRESH_TOKEN_EXCHANGE_FAILED="REFRESH_TOKEN_EXCHANGE_FAILED",r.NOT_FEDERATED="NOT_FEDERATED",r.UNKNOWN_ERROR_CODE="UNKNOWN_ERROR_CODE"})(I||(I={}));var E=class extends Error{constructor(e="UNKNOWN_ERROR",t=I.UNKNOWN_ERROR_CODE,i,o,n){super(e);let s=new.target.prototype;Object.setPrototypeOf(this,s),this.name="ArcGISTokenRequestError",this.message=`${t}: ${e}`,this.originalMessage=e,this.code=t,this.response=i,this.url=o,this.options=n}};var W=class extends Error{constructor(){super("The user has denied your authorization request.");let t=new.target.prototype;Object.setPrototypeOf(this,t),this.name="ArcGISAccessDeniedError"}};function m(r){return typeof r!="string"||(r=r.trim(),r[r.length-1]==="/"&&(r=r.slice(0,-1))),r}function pt(r){let[e,t]=r.split("=");return{key:decodeURIComponent(e),value:decodeURIComponent(t)}}function Le(r){return!r||r.length<=0?{}:r.replace(/^#/,"").replace(/^\?/,"").split("&").reduce((e,t)=>{let{key:i,value:o}=pt(t);return e[i]=o,e},{})}var Ge;(function(r){r.ArcGISRequestError="ArcGISRequestError",r.ArcGISAuthError="ArcGISAuthError",r.ArcGISAccessDeniedError="ArcGISAccessDeniedError",r.ArcGISTokenRequestError="ArcGISTokenRequestError"})(Ge||(Ge={}));var Oe=5*60*1e3;function V(r,e){let t=e;return t.rawResponse=!1,a(r,t).then(i=>{if("token"in i&&"expires"in i)return{token:i.token,username:e.params.username,expires:new Date(i.expires)};let o={token:i.access_token,username:i.username,expires:new Date(Date.now()+i.expires_in*1e3-Oe),ssl:i.ssl===!0};return i.refresh_token&&(o.refreshToken=i.refresh_token),i.refresh_token_expires_in&&(o.refreshTokenExpires=new Date(Date.now()+i.refresh_token_expires_in*1e3-Oe)),o})}var F=class{constructor(e){this.portal=e.portal?m(e.portal):"https://www.arcgis.com/sharing/rest",this._username=e.username}get username(){if(this._username)return this._username;if(this._user&&this._user.username)return this._user.username}getUsername(){return this.username?Promise.resolve(this.username):this.getUser().then(e=>e.username)}getUser(e){if(this._pendingUserRequest)return this._pendingUserRequest;if(this._user)return Promise.resolve(this._user);{let t=`${this.portal}/community/self`,i=Object.assign(Object.assign({httpMethod:"GET",authentication:this},e),{rawResponse:!1});return this._pendingUserRequest=a(t,i).then(o=>(this._user=o,this._pendingUserRequest=null,o)),this._pendingUserRequest}}clearCachedUserInfo(){this._user=null}};var z=class r extends F{constructor(e){super(e),this.portal="https://www.arcgis.com/sharing/rest",this.key=e.key}static fromKey(e){return typeof e=="string"?new r({key:e}):new r(e)}get token(){return this.key}getToken(e){return Promise.resolve(this.key)}toJSON(){return{type:"ApiKeyManager",token:this.key,username:this.username,portal:this.portal}}serialize(){return JSON.stringify(this)}static deserialize(e){let t=JSON.parse(e);return new r({key:t.token,username:t.username,portal:t.portal})}};var te=/^https?:\/\/(\S+)\.arcgis\.com.+/;function Be(r){return te.test(r)}function mt(r){if(!te.test(r))return r;switch(he(r)){case"dev":return"https://devext.arcgis.com/sharing/rest";case"qa":return"https://qaext.arcgis.com/sharing/rest";default:return"https://www.arcgis.com/sharing/rest"}}function he(r){if(!te.test(r))return null;let t=r.match(te)[1].split(".").pop();return t.includes("dev")?"dev":t.includes("qa")?"qa":"production"}function He(r,e){let t=m(mt(e)).replace(/https?:\/\//,""),i=m(r).replace(/https?:\/\//,"");return new RegExp(i,"i").test(t)}function Ve(r,e){let t=Be(r),i=Be(e),o=he(r),n=he(e);return!!(t&&i&&o===n)}function ze(r,e,t="https://www.arcgis.com/sharing/rest"){let i=`${t}/oauth2/validateAppAccess`;return a(i,{method:"POST",params:{f:"json",client_id:e,token:r}})}function Je(r){let e=`${m(r.portal||"https://www.arcgis.com/sharing/rest")}/oauth2/revokeToken/`,t=r.token,i=r.clientId;delete r.portal,delete r.clientId,delete r.token;let o=Object.assign(Object.assign({},r),{httpMethod:"POST",params:{client_id:i,auth_token:t}});return a(e,o).then(n=>{if(!n.success)throw new k("Unable to revoke token",500,n,e,o);return n})}function re(r,e=window){return!e&&window&&(e=window),e.btoa(String.fromCharCode.apply(null,r)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function Ke(r,e=window){if(!e&&window&&(e=window),r&&e.isSecureContext&&e.crypto&&e.crypto.subtle){let i=new e.TextEncoder().encode(r);return e.crypto.subtle.digest("SHA-256",i).then(o=>re(new Uint8Array(o),e))}return Promise.resolve(null)}function fe(r){!r&&window&&(r=window);let e=r.crypto.getRandomValues(new Uint8Array(32));return re(e)}function ht(r){return typeof r.userId=="string"||typeof r.expires=="number"}var v=class r extends F{constructor(e){if(super(e),this.clientId=e.clientId,this._refreshToken=e.refreshToken,this._refreshTokenExpires=e.refreshTokenExpires,this.password=e.password,this._token=e.token,this._tokenExpires=e.tokenExpires,this.portal=e.portal?m(e.portal):"https://www.arcgis.com/sharing/rest",this.ssl=e.ssl,this.provider=e.provider||"arcgis",this.tokenDuration=e.tokenDuration||20160,this.redirectUri=e.redirectUri,this.server=e.server,this.referer=e.referer,this.federatedServers={},this.trustedDomains=[],e.server){let t=this.getServerRootUrl(e.server);this.federatedServers[t]={token:e.token,expires:e.tokenExpires}}this._pendingTokenRequests={}}get token(){return this._token}get tokenExpires(){return this._tokenExpires}get refreshToken(){return this._refreshToken}get refreshTokenExpires(){return this._refreshTokenExpires}get canRefresh(){return!!(this.username&&this.password||this.clientId&&this.refreshToken&&this.redirectUri)}static beginOAuth2(e,t){!t&&window&&(t=window);let{portal:i,provider:o,clientId:n,expiration:s,redirectUri:c,popup:l,popupWindowFeatures:h,locale:d,params:y,style:b,pkce:R,state:u}=Object.assign({portal:"https://www.arcgis.com/sharing/rest",provider:"arcgis",expiration:20160,popup:!0,popupWindowFeatures:"height=400,width=600,menubar=no,location=yes,resizable=yes,scrollbars=yes,status=yes",locale:"",style:"",pkce:!0},e),f=u||fe(t),x=`ARCGIS_REST_JS_AUTH_STATE_${n}`;t.localStorage.setItem(x,f);let g=`${m(i)}/oauth2/authorize`,T={client_id:n,response_type:R?"code":"token",expiration:s,redirect_uri:c,state:JSON.stringify({id:f,originalUrl:t.location.href}),locale:d,style:b};o!=="arcgis"&&(g=`${m(i)}/oauth2/social/authorize`,T.socialLoginProviderName=o,T.autoAccountCreateForSocial=!0);let B;if(R){let j=fe(t),Z=`ARCGIS_REST_JS_CODE_VERIFIER_${n}`;t.localStorage.setItem(Z,j),B=Ke(j,t).then(function(_){T.code_challenge_method=_?"S256":"plain",T.code_challenge=_||j})}else B=Promise.resolve();return B.then(()=>{if(g=`${g}?${A(T)}`,y&&(g=`${g}&${A(y)}`),l)return new Promise((j,Z)=>{t.addEventListener(`arcgis-rest-js-popup-auth-${n}`,_=>{if(_.detail.error==="access_denied"){let K=new W;return Z(K),K}if(_.detail.errorMessage){let K=new M(_.detail.errorMessage,_.detail.error);return Z(K),K}j(new r({clientId:n,portal:i,ssl:_.detail.ssl,token:_.detail.token,tokenExpires:_.detail.expires,username:_.detail.username,refreshToken:_.detail.refreshToken,refreshTokenExpires:_.detail.refreshTokenExpires,redirectUri:c}))},{once:!0}),t.open(g,"oauth-window",h),t.dispatchEvent(new CustomEvent("arcgis-rest-js-popup-auth-start"))});t.location.href=g})}static completeOAuth2(e,t){!t&&window&&(t=window);let{portal:i,clientId:o,popup:n,pkce:s,redirectUri:c}=Object.assign({portal:"https://www.arcgis.com/sharing/rest",popup:!0,pkce:!0},e),l=`ARCGIS_REST_JS_AUTH_STATE_${o}`,h=t.localStorage.getItem(l),d=Le(s?t.location.search.replace(/^\?/,""):t.location.hash.replace(/^#/,"")),y=d&&d.state?JSON.parse(d.state):void 0;function b(u,f,x){if(t.localStorage.removeItem(l),n&&t.opener){t.opener.dispatchEvent(new CustomEvent(`arcgis-rest-js-popup-auth-${o}`,{detail:{error:f,errorMessage:u}})),t.close();return}return x&&t.history.replaceState(t.history.state,"",x),f==="access_denied"?Promise.reject(new W):Promise.reject(new M(u,f))}function R(u,f){if(t.localStorage.removeItem(l),n&&t.opener){t.opener.dispatchEvent(new CustomEvent(`arcgis-rest-js-popup-auth-${o}`,{detail:Object.assign({},u)})),t.close();return}return t.history.replaceState(t.history.state,"",f),new r({clientId:o,portal:i,ssl:u.ssl,token:u.token,tokenExpires:u.expires,username:u.username,refreshToken:u.refreshToken,refreshTokenExpires:u.refreshTokenExpires,redirectUri:c||location.href.replace(location.search,"")})}if(!h||!y)return b("No authentication state was found, call `ArcGISIdentityManager.beginOAuth2(...)` to start the authentication process.","no-auth-state");if(y.id!==h)return b("Saved client state did not match server sent state.","mismatched-auth-state");if(d.error){let u=d.error,f=d.error_description||"Unknown error";return b(f,u,y.originalUrl)}if(s&&d.code){let u=m(`${i}/oauth2/token/`),f=`ARCGIS_REST_JS_CODE_VERIFIER_${o}`,x=t.localStorage.getItem(f);return t.localStorage.removeItem(f),V(u,{httpMethod:"POST",params:{client_id:o,code_verifier:x,grant_type:"authorization_code",redirect_uri:c||location.href.replace(location.search,""),code:d.code}}).then(g=>R(Object.assign(Object.assign({},g),y),y.originalUrl)).catch(g=>b(g.originalMessage,g.code,y.originalUrl))}return!s&&d.access_token?Promise.resolve(R(Object.assign({token:d.access_token,expires:new Date(Date.now()+parseInt(d.expires_in,10)*1e3),ssl:d.ssl==="true",username:d.username},y),y.originalUrl)):b("Unknown error","oauth-error",y.originalUrl)}static fromParent(e,t){!t&&window&&(t=window);let i;return new Promise((o,n)=>{i=s=>{if(s.source===t.parent&&s.data)try{return o(r.parentMessageHandler(s))}catch(c){return n(c)}},t.addEventListener("message",i,!1),t.parent.postMessage({type:"arcgis:auth:requestCredential"},e)}).then(o=>(t.removeEventListener("message",i,!1),o))}static authorize(e,t){let{portal:i,clientId:o,expiration:n,redirectUri:s,state:c}=Object.assign({portal:"https://arcgis.com/sharing/rest",expiration:20160},e),l={client_id:o,expiration:n,response_type:"code",redirect_uri:s};c&&(l.state=c);let h=`${i}/oauth2/authorize?${A(l)}`;t.writeHead(301,{Location:h}),t.end()}static exchangeAuthorizationCode(e,t){let{portal:i,clientId:o,redirectUri:n}=Object.assign({portal:"https://www.arcgis.com/sharing/rest"},e);return V(`${i}/oauth2/token`,{params:{grant_type:"authorization_code",client_id:o,redirect_uri:n,code:t}}).then(s=>new r({clientId:o,portal:i,ssl:s.ssl,redirectUri:n,refreshToken:s.refreshToken,refreshTokenExpires:s.refreshTokenExpires,token:s.token,tokenExpires:s.expires,username:s.username})).catch(s=>{throw new E(s.message,I.REFRESH_TOKEN_EXCHANGE_FAILED,s.response,s.url,s.options)})}static deserialize(e){let t=JSON.parse(e);return new r({clientId:t.clientId,refreshToken:t.refreshToken,refreshTokenExpires:t.refreshTokenExpires?new Date(t.refreshTokenExpires):void 0,username:t.username,password:t.password,token:t.token,tokenExpires:t.tokenExpires?new Date(t.tokenExpires):void 0,portal:t.portal,ssl:t.ssl,tokenDuration:t.tokenDuration,redirectUri:t.redirectUri,server:t.server})}static fromCredential(e,t){let i=typeof e.ssl<"u"?e.ssl:!0,o=e.expires||Date.now()+72e5;return t.hasServer?new r({server:e.server,ssl:i,token:e.token,username:e.userId,tokenExpires:new Date(o)}):new r({portal:m(e.server.includes("sharing/rest")?e.server:e.server+"/sharing/rest"),ssl:i,token:e.token,username:e.userId,tokenExpires:new Date(o)})}static parentMessageHandler(e){if(e.data.type==="arcgis:auth:credential"){let t=e.data.credential;return ht(t)?r.fromCredential(t,{hasPortal:!0,hasServer:!1,server:t.server}):new r(t)}if(e.data.type==="arcgis:auth:error"){let t=new Error(e.data.error.message);throw t.name=e.data.error.name,t}else throw new Error("Unknown message type.")}static destroy(e){return Je({clientId:e.clientId,portal:e.portal,token:e.refreshToken||e.token})}static fromToken(e){let t=new r(e);return t.getUser().then(()=>t)}static signIn(e){let t=new r(e);return t.getUser().then(()=>t)}toCredential(){return{expires:this.tokenExpires.getTime(),server:this.server||this.portal,ssl:this.ssl,token:this.token,userId:this.username}}getPortal(e){if(this._pendingPortalRequest)return this._pendingPortalRequest;if(this._portalInfo)return Promise.resolve(this._portalInfo);{let t=`${this.portal}/portals/self`,i=Object.assign(Object.assign({httpMethod:"GET",authentication:this},e),{rawResponse:!1});return this._pendingPortalRequest=a(t,i).then(o=>(this._portalInfo=o,this._pendingPortalRequest=null,o)),this._pendingPortalRequest}}getToken(e,t){return Ve(this.portal,e)?this.getFreshToken(t):new RegExp(this.portal,"i").test(e)?this.getFreshToken(t):this.getTokenForServer(e,t)}validateAppAccess(e){return this.getToken(this.portal).then(t=>ze(t,e))}toJSON(){return{type:"ArcGISIdentityManager",clientId:this.clientId,refreshToken:this.refreshToken,refreshTokenExpires:this.refreshTokenExpires||void 0,username:this.username,password:this.password,token:this.token,tokenExpires:this.tokenExpires||void 0,portal:this.portal,ssl:this.ssl,tokenDuration:this.tokenDuration,redirectUri:this.redirectUri,server:this.server}}serialize(){return JSON.stringify(this)}enablePostMessageAuth(e,t){!t&&window&&(t=window),this._hostHandler=this.createPostMessageHandler(e),t.addEventListener("message",this._hostHandler,!1)}disablePostMessageAuth(e){!e&&window&&(e=window),e.removeEventListener("message",this._hostHandler,!1)}refreshCredentials(e){return this.clearCachedUserInfo(),this.username&&this.password?this.refreshWithUsernameAndPassword(e):this.clientId&&this.refreshToken?this.refreshWithRefreshToken():Promise.reject(new E("Unable to refresh token. No refresh token or password present.",I.TOKEN_REFRESH_FAILED))}getServerRootUrl(e){let[t]=m(e).split(/\/rest(\/admin)?\/services(?:\/|#|\?|$)/),[i,o,n]=t.match(/(https?:\/\/)(.+)/),[s,...c]=n.split("/");return`${o}${s.toLowerCase()}/${c.join("/")}`}getDomainCredentials(e){return!this.trustedDomains||!this.trustedDomains.length?"same-origin":(e=e.toLowerCase(),this.trustedDomains.some(t=>e.startsWith(t.toLowerCase()))?"include":"same-origin")}signOut(){return r.destroy(this)}createPostMessageHandler(e){return t=>{let i=e.indexOf(t.origin)>-1,o=t.data.type==="arcgis:auth:requestCredential",n=this.tokenExpires.getTime()>Date.now();if(i&&o){let s={};if(n){let c=this.toCredential();c.server=c.server.replace("/sharing/rest",""),s={type:"arcgis:auth:credential",credential:c}}else s={type:"arcgis:auth:error",error:{name:"tokenExpiredError",message:"Token was expired, and not returned to the child application"}};t.source.postMessage(s,t.origin)}}}getTokenForServer(e,t){let i=this.getServerRootUrl(e),o=this.federatedServers[i];return o&&o.expires&&o.expires.getTime()>Date.now()?Promise.resolve(o.token):this._pendingTokenRequests[i]?this._pendingTokenRequests[i]:(this._pendingTokenRequests[i]=this.fetchAuthorizedDomains().then(()=>a(`${i}/rest/info`,{credentials:this.getDomainCredentials(e)}).then(n=>{if(n.owningSystemUrl){if(He(n.owningSystemUrl,this.portal))return a(`${n.owningSystemUrl}/sharing/rest/info`,t);throw new E(`${e} is not federated with ${this.portal}.`,I.NOT_FEDERATED)}else{if(n.authInfo&&this.federatedServers[i]!==void 0)return Promise.resolve({authInfo:n.authInfo});throw new E(`${e} is not federated with any portal and is not explicitly trusted.`,I.NOT_FEDERATED)}}).then(n=>this.token&&this.tokenExpires.getTime()<Date.now()?this.server?this.refreshCredentials().then(()=>({token:this.token,expires:this.tokenExpires})):this.refreshCredentials().then(()=>this.generateTokenForServer(n.authInfo.tokenServicesUrl,i)):this.generateTokenForServer(n.authInfo.tokenServicesUrl,i)).then(n=>(this.federatedServers[i]=n,delete this._pendingTokenRequests[i],n.token))),this._pendingTokenRequests[i])}generateTokenForServer(e,t){return a(e,{params:{token:this.token,serverUrl:t,expiration:this.tokenDuration}}).then(i=>({token:i.token,expires:new Date(i.expires-1e3*60*5)})).catch(i=>{throw new E(i.message,I.GENERATE_TOKEN_FOR_SERVER_FAILED,i.response,i.url,i.options)})}getFreshToken(e){return this.token&&!this.tokenExpires?Promise.resolve(this.token):this.token&&this.tokenExpires&&this.tokenExpires.getTime()>Date.now()?Promise.resolve(this.token):(this._pendingTokenRequests[this.portal]||(this._pendingTokenRequests[this.portal]=this.refreshCredentials(e).then(()=>(this._pendingTokenRequests[this.portal]=null,this.token))),this._pendingTokenRequests[this.portal])}refreshWithUsernameAndPassword(e){let t={username:this.username,password:this.password,expiration:this.tokenDuration,client:"referer",referer:this.referer?this.referer:typeof window<"u"&&typeof window.document<"u"&&window.location&&window.location.origin?window.location.origin:me};return(this.server?a(`${this.getServerRootUrl(this.server)}/rest/info`).then(i=>a(i.authInfo.tokenServicesUrl,Object.assign({params:t},e))):a(`${this.portal}/generateToken`,Object.assign({params:t},e))).then(i=>(this.updateToken(i.token,new Date(i.expires)),this)).catch(i=>{throw new E(i.message,I.TOKEN_REFRESH_FAILED,i.response,i.url,i.options)})}refreshWithRefreshToken(e){if(this.refreshToken&&this.refreshTokenExpires&&this.refreshTokenExpires.getTime()-864e5<Date.now())return this.exchangeRefreshToken(e);let i=Object.assign({params:{client_id:this.clientId,refresh_token:this.refreshToken,grant_type:"refresh_token"}},e);return V(`${this.portal}/oauth2/token`,i).then(o=>this.updateToken(o.token,o.expires)).catch(o=>{throw new E(o.message,I.TOKEN_REFRESH_FAILED,o.response,o.url,o.options)})}updateToken(e,t){return this._token=e,this._tokenExpires=t,this}exchangeRefreshToken(e){let t=Object.assign({params:{client_id:this.clientId,refresh_token:this.refreshToken,redirect_uri:this.redirectUri,grant_type:"exchange_refresh_token"}},e);return V(`${this.portal}/oauth2/token`,t).then(i=>(this._token=i.token,this._tokenExpires=i.expires,this._refreshToken=i.refreshToken,this._refreshTokenExpires=i.refreshTokenExpires,this)).catch(i=>{throw new E(i.message,I.REFRESH_TOKEN_EXCHANGE_FAILED,i.response,i.url,i.options)})}fetchAuthorizedDomains(){return this.server||!this.portal?Promise.resolve(this):this.getPortal().then(e=>(e.authorizedCrossOriginDomains&&e.authorizedCrossOriginDomains.length&&(this.trustedDomains=e.authorizedCrossOriginDomains.filter(t=>!t.startsWith("http://")).map(t=>t.startsWith("https://")?t:`https://${t}`)),this))}};function N(r){return console.log("DEPRECATED:, 'UserSession' is deprecated. Use 'ArcGISIdentityManager' instead."),new v(r)}N.beginOAuth2=function(...r){return console.warn("DEPRECATED:, 'UserSession.beginOAuth2' is deprecated. Use 'ArcGISIdentityManager.beginOAuth2' instead."),v.beginOAuth2(...r)};N.completeOAuth2=function(...r){return console.warn("DEPRECATED:, 'UserSession.completeOAuth2()' is deprecated. Use 'ArcGISIdentityManager.completeOAuth2()' instead."),r.length<=1&&console.warn("WARNING:, 'UserSession.completeOAuth2()' is now async and returns a promise the resolves to an instance of `ArcGISIdentityManager`."),v.completeOAuth2(...r)};N.fromParent=function(...r){return console.warn("DEPRECATED:, 'UserSession.fromParent' is deprecated. Use 'ArcGISIdentityManager.fromParent' instead."),v.fromParent(...r)};N.authorize=function(...r){return console.warn("DEPRECATED:, 'UserSession.authorize' is deprecated. Use 'ArcGISIdentityManager.authorize' instead."),v.authorize(...r)};N.exchangeAuthorizationCode=function(...r){return console.warn("DEPRECATED:, 'UserSession.exchangeAuthorizationCode' is deprecated. Use 'ArcGISIdentityManager.exchangeAuthorizationCode' instead."),v.exchangeAuthorizationCode(...r)};N.fromCredential=function(...r){return console.log("DEPRECATED:, 'UserSession.fromCredential' is deprecated. Use 'ArcGISIdentityManager.fromCredential' instead."),console.warn("WARNING:, 'UserSession.fromCredential' now requires a `ServerInfo` object from the JS API as a second parameter."),v.fromCredential(...r)};N.deserialize=function(...r){return console.log("DEPRECATED:, 'UserSession.deserialize' is deprecated. Use 'ArcGISIdentityManager.deserialize' instead."),v.deserialize(...r)};var de;(function(r){r.Success="Succeeded",r.Failed="Failed",r.Waiting="Waiting",r.Cancelled="Cancelled",r.Cancelling="Cancelling",r.New="New",r.Executing="Executing",r.Submitted="Submitted",r.Failure="Failure",r.TimedOut="TimedOut",r.Error="Error",r.Status="Etatus",r.Unknown="Unknown"})(de||(de={}));var We="https://basemapstyles-api.arcgis.com/arcgis/rest/services/styles/v2/sessions/start";function ge({startSessionUrl:r,authentication:e,styleFamily:t="arcgis",duration:i=43200}){return a(r,{httpMethod:"GET",authentication:e,params:{styleFamily:t,durationSeconds:i}})}function Qe(r,e){return e||Math.min(Math.max(r/100,1),300)}var $=class{constructor(e){this.expirationTimerId=null,this.pendingSession=null,this.autoRefreshHandler=null,this.startSessionUrl=e.startSessionUrl,this.token=e.token,this.styleFamily=e.styleFamily||"arcgis",this.authentication=e.authentication,this.duration=e.duration||43200,this.startTime=e.startTime,this.endTime=e.endTime,this.expires=e.expires,this.safetyMargin=e.safetyMargin,this.expirationCheckInterval=Math.min(this.duration/100,10)*1e3,this.emitter=D()}isSessionExpired(){return this.isExpired&&(this.disableCheckingExpirationTime(),this.emitter.emit("expired",{token:this.token,startTime:this.startTime,endTime:this.endTime,expires:this.expires})),this.isExpired}enableCheckingExpirationTime(){let e=()=>{this.isSessionExpired()};return this.expirationTimerId||(this.expirationTimerId=setInterval(e,this.expirationCheckInterval)),setTimeout(()=>{e()},10),this.expirationTimerId}disableCheckingExpirationTime(){this.expirationTimerId&&(clearInterval(this.expirationTimerId),this.expirationTimerId=null)}static async startSession({startSessionUrl:e,styleFamily:t="arcgis",authentication:i,safetyMargin:o,duration:n=43200,autoRefresh:s=!1},c){if(n<10)throw new Error("Session duration must be at least 10 seconds.");if(n>43200)throw new Error("Session duration cannot exceed 12 hours (43200 seconds).");let l=await ge({startSessionUrl:e,styleFamily:t,authentication:i,duration:n}),h=Qe(n,o),d=new c({startSessionUrl:e,token:l.sessionToken,styleFamily:t,authentication:i,safetyMargin:h,expires:new Date(l.endTime-h*1e3),startTime:new Date(l.startTime),endTime:new Date(l.endTime),duration:n});return d.enableCheckingExpirationTime(),s&&d.enableAutoRefresh(),d}get checkingExpirationTime(){return!!this.expirationTimerId}get secondsUntilExpiration(){return Math.floor(this.millisecondsUntilExpiration/1e3)}get millisecondsUntilExpiration(){if(this.isExpired)return 0;let e=new Date;return this.endTime.getTime()-e.getTime()}get isExpired(){return this.expires<new Date}getToken(){return this.isExpired?this.refreshCredentials().then(()=>this.token):Promise.resolve(this.token)}get canRefresh(){return!0}get autoRefresh(){return!!this.autoRefreshHandler&&!!this.expirationTimerId}async refreshCredentials(){if(this.pendingSession)return await this.pendingSession,this;let e=JSON.parse(JSON.stringify({token:this.token,startTime:this.startTime,endTime:this.endTime,expires:this.expires}));try{this.pendingSession=ge({startSessionUrl:this.startSessionUrl,styleFamily:this.styleFamily,authentication:this.authentication,duration:this.duration});let t=await this.pendingSession;this.pendingSession=null,this.setToken(t.sessionToken),this.setStartTime(new Date(t.startTime)),this.setEndTime(new Date(t.endTime)),this.setExpires(new Date(t.endTime-this.safetyMargin*1e3)),this.enableCheckingExpirationTime(),this.emitter.emit("refreshed",{previous:{token:e.token,startTime:new Date(e.startTime),endTime:new Date(e.endTime),expires:new Date(e.expires)},current:{token:this.token,startTime:this.startTime,endTime:this.endTime,expires:this.expires}})}catch(t){throw this.emitter.emit("error",t),t}return this}enableAutoRefresh(){this.expirationTimerId||this.enableCheckingExpirationTime(),this.autoRefreshHandler=()=>{this.refreshCredentials().catch(e=>{this.emitter.emit("error",e)})},this.on("expired",this.autoRefreshHandler)}disableAutoRefresh(){this.autoRefreshHandler&&(this.off("expired",this.autoRefreshHandler),this.autoRefreshHandler=null)}destroy(){this.disableAutoRefresh(),this.disableCheckingExpirationTime(),this.emitter.off("expired"),this.emitter.off("refreshed"),this.emitter.off("error"),this.emitter.off("*")}on(e,t){this.emitter.on(e,t),this.isSessionExpired()}once(e,t){let i=o=>{this.emitter.off(e,i),t(o)};this.emitter.on(e,i)}off(e,t){this.emitter.off(e,t)}setToken(e){this.token=e}setStartTime(e){this.startTime=e}setEndTime(e){this.endTime=e}setExpires(e){this.expires=e}};$.error=function(e){};$.expired=function(e){};$.refreshed=function(e){};var oe=class r extends ${constructor(e){super(e)}static async start(e){return $.startSession(Object.assign(Object.assign({},e),{startSessionUrl:e?.startSessionUrl||We}),r)}};var ye=class r{constructor(e){this._emitter=D();this.expiredHandler=e=>{this._emitter.emit("BasemapSessionExpired",e)};this.refreshedHandler=e=>{this._emitter.emit("BasemapSessionRefreshed",e)};this.errorHandler=e=>{this._emitter.emit("BasemapSessionError",e)};if(!e?.token)throw new Error("A valid ArcGIS access token is required to start a session.");if(!e.styleFamily)throw new Error("BasemapSession must be initialized with a styleFamily: `arcgis` or `open`.");this._parentToken=e.token,this._options=e}get token(){if(!this._session?.token)throw new Error("Session token not available");return this._session.token}get styleFamily(){return this._session?this._session.styleFamily:this._options.styleFamily}get safeEndTime(){if(!this._session)throw new Error("Unable to get session expiration. Session not initialized.");return this._session.expires}get startTime(){if(!this._session)throw new Error("Unable to get start time. Session not initialized.");return this._session.startTime}get endTime(){if(!this._session)throw new Error("Unable to get end time. Session not initialized.");return this._session.endTime}get isStarted(){return!!(this._session&&this._session.token!==void 0&&this._session.expires&&this._session.expires>new Date)}async initialize(){this._session&&(this._session.off("expired",this.expiredHandler),this._session.off("refreshed",this.refreshedHandler),this._session.off("error",this.errorHandler),this._emitter.all.clear());let e={authentication:z.fromKey(this._parentToken),autoRefresh:!!this._options.autoRefresh,duration:this._options.duration,safetyMargin:this._options.safetyMargin,styleFamily:this._options.styleFamily,startSessionUrl:this._options.startSessionUrl};e.autoRefresh&&console.warn("Auto-refresh is enabled. Your basemap session will automatically refresh once the 'duration' elapses."),this._session=await oe.start(e),this.setupEventListeners()}async refresh(){if(!this._session)throw new Error("Session not initialized");try{this._session=await this._session.refreshCredentials()}catch(e){this._emitter.emit("BasemapSessionError",e)}}setupEventListeners(){this._session&&(this._session.on("expired",this.expiredHandler),this._session.on("refreshed",this.refreshedHandler),this._session.on("error",this.errorHandler))}on(e,t){this._emitter.on(e,t)}off(e,t){this._emitter.off(e,t)}static async start(e){let t=new r(e);return await t.initialize(),t}};var C=r=>r.length==32?"ItemId":null,J=r=>{if(/^https?:\/\//.test(r)){if(/\/VectorTileServer\/?$/.exec(r))return"VectorTileService";let i=/\/FeatureServer\/?([0-9]*\/?)?$/.exec(r);if(i)return i.length==2&&i[1]?"FeatureLayer":"FeatureService"}return null},P=r=>(r[r.length-1]!=="/"&&(r+="/"),r),Q=r=>!!(!r.startsWith("http://")&&!r.startsWith("https://")&&r.includes("../")),Y=(r,e)=>URL.parse(r,e).href,ne=r=>r?(r=gt(r),r=r.replace(/^https?:\/\/www\.arcgis\.com/,"https://cdn.arcgis.com"),r=r.replace(/^https?:\/\/devext\.arcgis\.com/,"https://cdndev.arcgis.com"),r=r.replace(/^https?:\/\/qaext\.arcgis\.com/,"https://cdnqa.arcgis.com"),r):r||null,gt=r=>{let e=/^https?:\/\/(?:cdn|[a-z\d-]+\.maps)\.arcgis\.com/i,t=/^https?:\/\/(?:cdndev|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,i=/^https?:\/\/(?:cdnqa|[a-z\d-]+\.mapsqa)\.arcgis\.com/i;return e.test(r)?r=r.replace(e,"https://www.arcgis.com"):t.test(r)?r=r.replace(t,"https://devext.arcgis.com"):i.test(r)&&(r=r.replace(i,"https://qaext.arcgis.com")),r},L=(...r)=>{console&&console.warn&&console.warn.apply(console,r)},yt=r=>{if(!r||r.length===0)return null;let e=["AAPT","AAPK","AATK"];for(let i of e)if(r.startsWith(i))return"app";let t=["AAST"];for(let i of t)if(r.startsWith(i))return"basemapSession";return r.length==256?"user":(r.length===128,"app")},G=async(r,e)=>{if(!r||r.length===0)return null;let t=yt(r);return t==="user"?await v.fromToken({token:r,portal:e||"https://www.arcgis.com/sharing/rest"}):t==="app"||t==="basemapSession"?z.fromKey({key:r,portal:e||"https://www.arcgis.com/sharing/rest"}):null};var Ye="https://basemapstyles-api.arcgis.com/arcgis/rest/services/styles/v2/styles",be=class r{constructor(e){this._emitter=D();this._styleLoadHandler=e=>{this._emitter.emit("BasemapStyleLoad",e)};this._styleErrorHandler=e=>{this._emitter.emit("BasemapStyleError",e)};this._attributionLoadHandler=e=>{this._emitter.emit("BasemapAttributionLoad",e)};if(!e||!e.style)throw new Error("BasemapStyle must be created with a style name, such as 'arcgis/imagery' or 'open/streets'.");if(e.session)this.session=e.session;else if(e.token)this.token=e.token;else throw new Error("ArcGIS access token required. To learn more, go to https://developers.arcgis.com/documentation/security-and-authentication/get-started/.");this.styleId=e.style,this._baseUrl=e?.baseUrl||Ye,this._isItemId=C(this.styleId)=="ItemId",e.attributionControl&&(this._attributionControlOptions=e.attributionControl),e?.preferences&&this._updatePreferences({language:e.preferences.language,worldview:e.preferences.worldview,places:e.preferences.places})}get _styleUrl(){let e=this._isItemId?`${this._baseUrl}/items/${this.styleId}`:`${this._baseUrl}/${this.styleId}`;return e+=`?token=${this._token}`,this.preferences?.language&&(e+=`&language=${this.preferences.language}`),this.preferences?.worldview&&(e+=`&worldview=${this.preferences.worldview}`),this.preferences?.places&&(e+=`&places=${this.preferences.places}`),e}get _token(){if(this.session)return this.session.token;if(this.token)return this.token}setMap(e){return this._map=e,this}applyTo(e,t){if(e&&(this._map=e),!this._map)throw new Error("Unable to apply basemap style: No 'Map' object was provided.");if(!this.style)throw new Error("Cannot apply style to map before style is loaded.");return this._map.setStyle(this.style,t),this._setEsriAttribution(),this.session&&this.session.on("BasemapSessionRefreshed",i=>{let o=i.previous.token,n=i.current.token;this._updateTiles(o,n,e)}),this._map}async updateStyle(e){return e.style&&(this.styleId=e.style),e.token&&(this.token=e.token),e.preferences&&this._updatePreferences(e.preferences),await this.loadStyle(),this.applyTo(this._map,e.maplibreStyleOptions),this.style}async loadStyle(){if(this.session){let o=await Promise.resolve(this.session);this.session=o}let e=this._isItemId?`${this._baseUrl}/items/${this.styleId}`:`${this._baseUrl}/${this.styleId}`,t=await G(this._token),i=await a(e,{authentication:t,httpMethod:"GET",suppressWarnings:!0,params:{...this.preferences,echoToken:!1}}).catch(o=>{this._styleErrorHandler(o)});if(i)return i.glyphs&&(i.glyphs=`${i.glyphs}?f=json&token=${this.token}`),Object.keys(i.sources).forEach(o=>{let n=i.sources[o];if((n.type==="raster"||n.type==="vector"||n.type==="raster-dem")&&n.tiles.length>0)for(let s=0;s<n.tiles.length;s++)n.tiles[s]=`${n.tiles[s]}?f=json&token=${this.token}`}),i.sprite&&(Array.isArray(i.sprite)?i.sprite.forEach((o,n,s)=>{s[n].url=`${o.url}?token=${this._token}`}):i.sprite=`${i.sprite}?token=${this._token}`),this.style=i,this._styleLoadHandler(this),this.style}_setEsriAttribution(){if(!this._map)throw new Error("No map was passed to ArcGIS BasemapStyle.");this.attributionControl=new H(this._attributionControlOptions),this.attributionControl.canAdd(this._map)&&(this._map.addControl(this.attributionControl),this._attributionLoadHandler(this.attributionControl))}_updatePreferences(e){if(e){if(this._isItemId){console.warn("Preferences such as 'language', 'places', and 'worldview' are not supported with custom basemaps IDs. These parameters will be ignored.");return}this.preferences||(this.preferences={}),e.language&&(this.preferences.language=e.language),e.places&&(this.preferences.places=e.places),e.worldview&&(this.preferences.worldview=e.worldview)}}_updateTiles(e,t,i){if(!i)throw new Error("Unable to update map tiles with new session token: Session does not have access to the map.");this._map=i;for(let s of Object.keys(this._map.style.sourceCaches)){let c=this._map.getSource(s);if(!c||!c.tiles||!c.tiles.some(h=>h.includes(e)))return;let l=c.tiles.map(h=>h.includes(e)?h.replace(e,t):h);c.setTiles(l)}let o=this._map.getGlyphs();o.includes(e)&&this._map.setGlyphs(o.replace(e,t));let n=this._map.getSprite();for(let s of n)s.url.includes(e)&&this._map.setSprite(s.url.replace(e,t))}on(e,t){this._emitter.on(e,t)}off(e,t){this._emitter.off(e,t)}static url(e){return new r(e)._styleUrl}static applyStyle(e,t){if(!e)throw new Error("Must provide a maplibre-gl 'Map' to apply style to.");let i=new r(t);return i.loadStyle().then(o=>{i.applyTo(e,t.maplibreStyleOptions)}).catch(o=>{throw o}),i}static async getSelf(e){let t=e?.baseUrl?e.baseUrl:Ye,i=await G(e?.token);return await a(`${t}/self`,{authentication:i,httpMethod:"GET"})}};function p(r={}){return r.portal?m(r.portal):r.authentication&&typeof r.authentication!="string"?r.authentication.portal:"https://www.arcgis.com/sharing/rest"}var wt=/[\x00-\x1F\x7F-\x9F\xA0]/g;function Xe(r){return r.replace(wt,"")}function se(r,e){let t=xe(r,e),i=Object.assign({httpMethod:"GET"},e);return a(t,i)}var xe=(r,e)=>`${typeof e=="string"?e:p(e)}/content/items/${r}`;function Ze(r,e){let t=`${xe(r,e)}/resources`,i=Object.assign({},e);return i.params=Object.assign({num:1e3},i.params),a(t,i)}function we(r,e){let t=e.readAs||"blob";return St(r,`/resources/${e.fileName}`,t,e)}function St(r,e,t,i){let o=`${xe(r,i)}${e}`,n=Object.assign({params:{}},i),s=n.rawResponse;return n.rawResponse=!0,n.params.f=null,a(o,n).then(c=>s?c:t!=="json"?c[t]():c.text().then(l=>JSON.parse(Xe(l))))}function Ie(r){return a(m(r.url),r)}var sl=new RegExp(/.+(?:map|feature|image)server/i);function et(r){return a(m(r.url),r)}function tt(r){let e=S(r,["where","objectIds","relationParam","time","distance","units","outFields","geometry","geometryType","spatialRel","returnGeometry","maxAllowableOffset","geometryPrecision","inSR","outSR","gdbVersion","returnDistinctValues","returnIdsOnly","returnCountOnly","returnExtentOnly","orderByFields","groupByFieldsForStatistics","outStatistics","returnZ","returnM","multipatchOption","resultOffset","resultRecordCount","quantizationParameters","returnCentroid","resultType","historicMoment","returnTrueCurves","sqlFormat","returnExceededLimitFeatures","f"],{httpMethod:"GET",params:Object.assign({where:"1=1",outFields:"*"},r.params)});return a(`${m(r.url)}/query`,e)}async function rt(r){var e,t;let i=0,o=!0,n=null,c=(await a(r.url,{httpMethod:"GET"})).maxRecordCount||2e3,l=(e=r.params)===null||e===void 0?void 0:e.resultRecordCount,h=l&&l<=c?l:c;for(;o;){let d=Object.assign(Object.assign({},r),{params:Object.assign(Object.assign({where:"1=1",outFields:"*"},r.params||{}),{resultOffset:i,resultRecordCount:h})}),y=S(d,["where","objectIds","relationParam","time","distance","units","outFields","geometry","geometryType","spatialRel","returnGeometry","maxAllowableOffset","geometryPrecision","inSR","outSR","gdbVersion","orderByFields","groupByFieldsForStatistics","outStatistics","returnZ","returnM","multipatchOption","resultOffset","resultRecordCount","quantizationParameters","resultType","historicMoment","returnTrueCurves","sqlFormat","f"],{httpMethod:"GET",params:Object.assign({where:"1=1",outFields:"*",returnExceededLimitFeatures:!0},d.params)}),b=await a(`${m(r.url)}/query`,y);n?n.features=n.features.concat(b.features):n=Object.assign({},b);let R=b.features.length,u=b.exceededTransferLimit||((t=b.properties)===null||t===void 0?void 0:t.exceededTransferLimit);R<c||!u?o=!1:i+=c}return n}var X=r=>{throw new Error(`${r} is a read-only property.`)},O=class r{constructor(){if(new.target===r)throw new Error("HostedLayer is an abstract class and cannot be instantiated directly.")}get sources(){return Object.freeze(this._sources)}set sources(e){X("sources")}get source(){let e=Object.keys(this._sources);if(e.length===1)return Object.freeze(this._sources[e[0]])}set source(e){X("source")}get sourceId(){let e=Object.keys(this._sources);if(e.length===1)return Object.freeze(e[0])}set sourceId(e){X("sourceId")}get layers(){return Object.freeze(this._layers)}set layers(e){X("layers")}get layer(){if(this._layers.length===1)return Object.freeze(this._layers[0])}set layer(e){X("layer")}_onAdd(e){if(e&&(this._map=e),!this._map)throw new Error("No map");let t=new Re;t.canAdd(this._map)&&this._map.addControl(t)}setSourceId(e,t){let i=structuredClone(this._sources);i[t]=i[e],delete i[e],this._sources=i,this._layers.forEach(o=>{o.source==e&&(o.source=t)})}setAttribution(e,t){if(!e||!t)throw new Error("Must provide a source ID and attribution");let i=structuredClone(this._sources);i[e].attribution=t,this._sources=i}copySource(e){return structuredClone(this._sources[e])}copyLayer(e){for(let t=0;t<this._layers.length;t++)if(this._layers[t].id==e)return structuredClone(this._layers[t]);throw new Error(`No layer with ID ${e} exists.`)}addSourcesAndLayersTo(e){if(!this._ready)throw new Error("Cannot add sources and layers to map: Layer is not loaded.");return this._map=e,Object.keys(this._sources).forEach(t=>{e.addSource(t,this._sources[t])}),this._layers.forEach(t=>{e.addLayer(t)}),this._onAdd(e),this}addSourcesTo(e){if(!this._ready)throw new Error("Cannot add sources to map: Layer is not loaded.");return this._map=e,Object.keys(this._sources).forEach(t=>{e.addSource(t,this._sources[t])}),this._onAdd(e),this}addLayersTo(e){if(!this._ready)throw new Error("Cannot add layers to map: Layer is not loaded.");return this._map=e,this._layers.forEach(t=>{e.addLayer(t)}),this._onAdd(e),this}};var Ee={esriGeometryPoint:{type:"circle",limit:{maxPointCount:2e5,maxRecordCount:2e5}},esriGeometryMultipoint:{type:"circle",limit:{maxPointCount:8e4,maxRecordCount:8e4}},esriGeometryPolyline:{type:"line",limit:{maxVertexCount:25e4,maxRecordCount:8e3}},esriGeometryPolygon:{type:"fill",limit:{maxVertexCount:25e4,maxRecordCount:8e3}},esriGeometryEnvelope:{type:"fill",limit:{maxVertexCount:25e4,maxRecordCount:8e3}}},Tt={circle:{"circle-color":"rgb(0,0,0)"},line:{"line-color":"rgb(0,0,0)","line-width":3},fill:{"fill-color":"rgba(0,0,0,0.25)","fill-outline-color":"rgb(0,0,0)"}},ve=class r extends O{constructor(e){if(super(),!e||!(e.itemId||e.url))throw new Error("Feature layer requires either an 'itemId' or 'url'.");if(e?.token&&(this.token=e.token),e?.attribution&&(this._customAttribution=e.attribution),e.itemId&&e.url&&L("Both an item ID and service URL have been passed. Only the item ID will be used."),e.itemId)if(C(e.itemId)=="ItemId")this._inputType="ItemId";else throw new Error("Argument `itemId` is not a valid item ID.");else if(e.url){let t=J(e.url);if(t&&(t=="FeatureLayer"||t=="FeatureService"))this._inputType=t;else throw new Error("Argument `url` is not a valid feature service URL.")}this._inputType=="ItemId"?this._itemInfo={itemId:e.itemId,portalUrl:e?.portalUrl?e.portalUrl:"https://www.arcgis.com/sharing/rest"}:(this._inputType==="FeatureLayer"||this._inputType==="FeatureService")&&(this._serviceInfo={serviceUrl:P(e.url)}),e?.query&&(this.query=e.query)}async _fetchAllFeatures(e,t){if(!t.supportedQueryFormats.includes("geoJSON"))throw new Error("This feature service does not support GeoJSON format.");if(!t.capabilities.includes("Query"))throw new Error("This feature service does not support queries.");if(!t.advancedQueryCapabilities.supportsPagination)throw new Error("This feature service does not support query pagination.");if(!t.geometryType||!Object.keys(Ee).includes(t.geometryType))throw new Error("This feature service contains an unsupported geometry type.");let i;if(t.supportsExceedsLimitStatistics){let o=Ee[t.geometryType].limit,n,s;if(this.query)if(this.query.ignoreLimits){let{ignoreLimits:l,...h}=this.query;s=l,n=h}else n=this.query,s=!1;if((await tt({url:e,authentication:this._authentication,...structuredClone(n),outStatistics:[{onStatisticField:null,statisticType:"exceedslimit",outStatisticFieldName:"exceedslimit",...o}],returnGeometry:!1,params:{cacheHint:!0}})).features[0].attributes.exceedslimit===0||s)s&&L(`Feature count limits are being ignored from ${e}. This is recommended only for low volume layers and applications and will cause poor server performance and crashes.`),i=await rt({url:e,authentication:this._authentication,...structuredClone(n),f:"geojson"});else throw new Error(`The requested feature count from ${e} exceeds the current limits of this plugin. Please use the ArcGIS Maps SDK for JavaScript, or host your data as a vector tile layer higher limits are planned for future versions of this plugin. You may also set ignoreLimits: true in the options to ignore these limits and load all features. This is recommended only for low volume layers and applications and will cause poor server performance and crashes.`)}else throw new Error("Feature layers hosted in old versions of ArcGIS Enterprise are not supported by this plugin. https://github.com/Esri/maplibre-arcgis/issues/5");if(!i)throw new Error("Unable to load data.");return i}async _loadLayer(e){let t=await Ie({authentication:this._authentication,url:e,httpMethod:"GET"}),i=await this._fetchAllFeatures(e,t),o=t.name;o in this._sources&&(o+=e[e.length-2]),this._sources[o]={type:"geojson",attribution:this._setupAttribution(t),data:i};let n=Ee[t.geometryType].type,s={source:o,id:`${o}-layer`,type:n,paint:Tt[n]};this._layers.push(s)}async _loadData(){this._sources={},this._layers=[],this._authentication=await G(this.token,this._itemInfo?.portalUrl);let e=this._inputType;switch(e){case"ItemId":{let t=await se(this._itemInfo.itemId,{authentication:this._authentication});if(!t.url)throw new Error("The provided ArcGIS portal item has no associated service URL.");this._itemInfo={...this._itemInfo,accessInformation:t.accessInformation,title:t.title,description:t.description,access:t.access,orgId:t.orgId,licenseInfo:t.licenseInfo},this._serviceInfo={serviceUrl:t.url},e="FeatureService"}case"FeatureService":{let t=await et({url:this._serviceInfo.serviceUrl,authentication:this._authentication});if(t.copyrightText&&(this._serviceInfo.copyrightText=t.copyrightText),t.layers.length>1&&this.query)throw new Error("Unable to use `query` parameter: This feature service contains multiple feature layers.");t.layers.length>10&&L("This feature service contains more than 10 layers. Only the first 10 layers will be loaded.");for(let i=0;i<t.layers.length&&i<10;i++){if(t.layers[i].subLayerIds){L("Feature layers with sublayers are not supported. This layer will not be added.");return}await this._loadLayer(`${P(this._serviceInfo.serviceUrl)}${i}/`)}break}case"FeatureLayer":{await this._loadLayer(this._serviceInfo.serviceUrl);break}}}_setupAttribution(e){return this._customAttribution?this._customAttribution:this._itemInfo?.accessInformation?this._itemInfo.accessInformation:e.copyrightText?e.copyrightText:this._serviceInfo?.copyrightText?this._serviceInfo.copyrightText:""}async initialize(){return await this._loadData(),this._ready=!0,this}static async fromUrl(e,t){let i=J(e);if(!i||!(i==="FeatureService"||i==="FeatureLayer"))throw new Error("Must provide a valid feature layer URL.");let o=new r({url:e,...t});return await o.initialize(),o}static async fromPortalItem(e,t){if(C(e)!=="ItemId")throw new Error("Must provide a valid item ID for an ArcGIS hosted feature layer.");let i=new r({itemId:e,...t});return await i.initialize(),i}};var Te=class r extends O{constructor(e){if(super(),this._ready=!1,this._styleLoaded=!1,this._serviceInfoLoaded=!1,this._itemInfoLoaded=!1,!e||!(e.itemId||e.url))throw new Error("Vector tile layer requires either an 'itemId' or 'url'.");if(e.token&&(this.token=e.token),e.attribution&&(this._customAttribution=e.attribution),e.itemId&&e.url&&console.warn("Both an item ID and service URL have been passed. Only the item ID will be used."),e.itemId)if(C(e.itemId)=="ItemId")this._inputType="ItemId";else throw new Error("Argument `itemId` is not a valid item ID.");else if(e.url)if(J(e.url)=="VectorTileService")this._inputType="VectorTileService";else throw new Error("Argument `url` is not a valid vector tile service URL.");this._inputType==="ItemId"?this._itemInfo={itemId:e.itemId,portalUrl:e?.portalUrl?e.portalUrl:"https://www.arcgis.com/sharing/rest"}:this._inputType==="VectorTileService"&&(this._serviceInfo={serviceUrl:P(e.url)})}async _loadStyle(){let e=null;this._authentication=await G(this.token,this._itemInfo?.portalUrl);let t=this._inputType;switch(t){case"ItemId":{if(await this._loadItemInfo(),e=await this._loadStyleFromItemId(),e)break;L("Could not find a style resource associated with the provided item ID. Checking service URL instead..."),t="VectorTileService"}case"VectorTileService":{await this._loadServiceInfo(),e=await this._loadStyleFromServiceUrl();break}}if(!e)throw new Error("Unable to load style information from service URL or item ID.");return this._styleLoaded=!0,this.style=e,this.style}async _loadStyleFromItemId(){let e={authentication:this._authentication},t=null;try{t=await we(this._itemInfo.itemId,{...e,fileName:"styles/root.json",readAs:"json"})}catch{let i=await Ze(this._itemInfo.itemId,{...e}),o;if(i.total>0){for(let n of i.resources)if(n.resource.startsWith("styles")){o=n.resource;break}}o&&(t=await we(this._itemInfo.itemId,{...e,fileName:o,readAs:"json"}))}return t}async _loadStyleFromServiceUrl(){if(!this._serviceInfo.serviceUrl)throw new Error("No data service provided");return this._serviceInfo.styleEndpoint||(this._serviceInfo.styleEndpoint="resources/styles/"),await a(`${this._serviceInfo.serviceUrl}${this._serviceInfo.styleEndpoint}`,{authentication:this._authentication})}async _loadServiceInfo(){let e=await a(this._serviceInfo.serviceUrl,{authentication:this._authentication});return this._serviceInfo={...this._serviceInfo,tiles:e.tiles,styleEndpoint:P(e.defaultStyles),copyrightText:e.copyrightText},this._serviceInfoLoaded=!0,this._serviceInfo}async _loadItemInfo(){let e=await se(this._itemInfo.itemId,{authentication:this._authentication});if(!e.url)throw new Error("Provided ArcGIS item ID has no associated data service.");return this._serviceInfoLoaded||(this._serviceInfo={serviceUrl:P(e.url)}),this._itemInfo={...this._itemInfo,accessInformation:e.accessInformation,title:e.title,description:e.description,access:e.access,orgId:e.orgId,licenseInfo:e.licenseInfo},this._itemInfoLoaded=!0,this._itemInfo}_cleanStyle(e){if(!e)throw new Error("Vector tile style has not been loaded from ArcGIS.");if(!this._serviceInfo.serviceUrl)throw new Error("No data service provided");this._serviceInfo.styleEndpoint||(this._serviceInfo.styleEndpoint="resources/styles/");let t=`${this._serviceInfo.serviceUrl}${this._serviceInfo.styleEndpoint}`;if(e.glyphs&&(Q(e.glyphs)&&(e.glyphs=Y(e.glyphs,t)),e.glyphs=ne(e.glyphs),this._authentication&&(e.glyphs=`${e.glyphs}?token=${this._authentication.token}`)),e.sprite)if(Array.isArray(e.sprite))for(let i=0;i<e.sprite.length;i++){let o=e.sprite[i];Q(o.url)&&(o.url=Y(o.url,t)),o.url=ne(o.url),this._authentication&&(o.url=`${o.url}?token=${this._authentication.token}`)}else Q(e.sprite)&&(e.sprite=Y(e.sprite,t)),e.sprite=ne(e.sprite),this._authentication&&(e.sprite=`${e.sprite}?token=${this._authentication.token}`);for(let i=0;i<e.layers.length;i++){let o=e.layers[i];o.layout&&o.layout["text-font"]&&o.layout["text-font"].length>1&&(o.layout["text-font"]=o.layout["text-font"])}for(let i of Object.keys(e.sources)){let o=e.sources[i];Q(o.url)&&(o.url=Y(o.url,t)),o.url=P(o.url),o.tiles||(this._serviceInfo.tiles?o.tiles=[`${o.url}${this._serviceInfo.tiles[0]}`]:o.tiles=[`${o.url}tile/{z}/{y}/{x}.pbf`]),this._authentication&&(o.url&&(o.url=`${o.url}?token=${this._authentication.token}`),o.tiles&&(o.tiles=o.tiles.map(n=>`${n}?token=${this._authentication.token}`))),o.attribution=this._getAttribution(i)}this._sources=e.sources,this._layers=e.layers}_getAttribution(e){return this._customAttribution?this._customAttribution:this._itemInfoLoaded&&this._itemInfo.accessInformation?this._itemInfo.accessInformation:this._serviceInfoLoaded&&this._serviceInfo.copyrightText?this._serviceInfo.copyrightText:this._styleLoaded&&e&&this.style.sources[e]&&this.style.sources[e].attribution?this.style.sources[e].attribution:""}async initialize(){if(this._ready)throw new Error("Vector tile layer has already been initialized. Cannot initialize again.");let e=await this._loadStyle();return this._cleanStyle(e),this._ready=!0,this}static async fromPortalItem(e,t){if(C(e)!=="ItemId")throw new Error("Input is not a valid ArcGIS item ID.");let i=new r({itemId:e,...t});return await i.initialize(),i}static async fromUrl(e,t){if(J(e)!=="VectorTileService")throw new Error("Input is not a valid ArcGIS vector tile service URL.");let i=new r({url:e,...t});return await i.initialize(),i}};var it={name:"@esri/maplibre-arcgis",version:"1.0.1",description:"Wrapper for integrating ArcGIS data sources with MapLibre GL JS",keywords:["maplibre","arcgis","esri","feature","vector","tile","styles"],scripts:{prebuild:"mkdirp dist",build:"node build.js prod","build-dev":"node build.js dev",start:"node build.js prod watch","start-dev":"node build.js dev watch",test:"vitest",format:"eslint . --fix",docs:"typedoc"},license:"Apache-2.0",contributors:[{name:"George Owen",email:"gowen@esri.com",url:"https://github.com/gowin20"},{name:"Mark Torrey",email:"mtorrey@esri.com",url:"https://github.com/MarkTorrey"},{name:"Patrick Arlt",email:"parlt@esri.com",url:"https://github.com/patrickarlt"}],type:"module",peerDependencies:{"maplibre-gl":">=5.0.0"},dependencies:{"@esri/arcgis-rest-basemap-sessions":"^1.1.0","@esri/arcgis-rest-feature-service":"^4.3.0","@esri/arcgis-rest-portal":"^4.6.2","@esri/arcgis-rest-request":"^4.7.2",mitt:"3.0.1"},devDependencies:{"@eslint/js":"^9.30.1","@fal-works/esbuild-plugin-global-externals":"^2.1.2","@stylistic/eslint-plugin":"^5.2.2","@types/node":"^24.3.0","@vitest/coverage-v8":"^3.2.4","@vitest/eslint-plugin":"^1.3.4",canvas:"^3.2.0",dotenv:"^17.2.1",esbuild:"^0.25.4","esbuild-plugin-umd-wrapper":"^3.0.0",eslint:"^9.30.1","eslint-plugin-html":"^8.1.3","eslint-plugin-tsdoc":"^0.4.0","gh-release":"^7.0.2",globals:"^16.3.0",jsdom:"^26.1.0","maplibre-gl":"^5.14.0",mkdirp:"^3.0.1",puppeteer:"^24.19.0",typedoc:"^0.28.9",typescript:"^5.8.3","typescript-eslint":"^8.36.0",vitest:"^3.2.4","vitest-fetch-mock":"^0.4.5","vitest-webgl-canvas-mock":"^1.1.0"},main:"dist/umd/maplibre-arcgis.min.js",module:"dist/esm/maplibre-arcgis.min.js",unpkg:"dist/umd/maplibre-arcgis.min.js",exports:{".":{import:"./dist/esm/maplibre-arcgis.min.js",require:"./dist/umd/maplibre-arcgis.min.js"},"./package.json":"./package.json"},directories:{example:"examples",test:"test"},homepage:"https://github.com/Esri/maplibre-arcgis#readme",bugs:{url:"https://github.com/Esri/maplibre-arcgis/issues"},repository:{type:"git",url:"git+https://github.com/Esri/maplibre-arcgis.git"},publishConfig:{access:"public"},esri:{keyExports:["BasemapStyle","FeatureLayer","VectorTileLayer","AttributionControl","BasemapSession"]}};var ot=window;ot&&ot.TEST_ENVIRONMENT&&new EventSource("/esbuild").addEventListener("change",()=>location.reload());var Hu=it.version;export{H as AttributionControl,ye as BasemapSession,be as BasemapStyle,at as EsriAttribution,ve as FeatureLayer,O as HostedLayer,Hu as VERSION,Te as VectorTileLayer};
/*! Bundled license information:

@esri/arcgis-rest-basemap-sessions/dist/esm/BaseSession.js:
  (* istanbul ignore next -- @preserve *)
*/
//# sourceMappingURL=maplibre-arcgis.min.js.map
