<!--

To run this demo, you need to replace 'YOUR_ACCESS_TOKEN' with an access token from ArcGIS that has the correct privileges.

To get started, sign up for a free ArcGIS Location Platform account or a free trial of ArcGIS Online and create developer credentials.

https://developers.arcgis.com/documentation/security-and-authentication/get-started/

-->
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>MapLibre GL JS Tutorials: Change the basemap style</title>

    <style>
      html,
      body,
      #map {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 14px;
        color: #323232;
      }

      #basemaps-wrapper {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0);
      }

      #basemaps {
        font-size: 16px;
        padding: 4px 8px;
      }

      #currentSessionInfo {
        position: absolute;
        top: 20px;
        left: 20px;

        z-index: 1001;
        background: rgba(255, 255, 255, 0.75);
        display: flex;
        flex-direction: column;
        padding: 10px;
      }

      .row {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
    </style>
    <!-- Load MapLibre GL JS from CDN -->
    <script src="https://unpkg.com/maplibre-gl@5.6.1/dist/maplibre-gl.js"></script>
    <link
      href="https://unpkg.com/maplibre-gl@5.6.1/dist/maplibre-gl.css"
      rel="stylesheet"
    />

    <!-- Load MapLibre ArcGIS from CDN -->
    <!-- <script src="https://basemap-sessions-preview.gha.afd.arcgis.com/maplibre-gl-js//maplibre-arcgis/maplibre-arcgis-debug.js"></script> -->

    <script src="../dist/maplibre-arcgis-debug.js"></script>
    <script src="../debug/apikey.js"></script>
  </head>

  <body>
    <div id="currentSessionInfo">
      <h4>Current Session:</h4>
      <div class="row">
        <label id="styleFamilyLbl">Style family: </label>
        <input id="styleFamilyInput" readonly />
      </div>
      <div class="row">
        <label id="startTimeLbl">Start time: </label>
        <input id="startTimeInput" readonly />
      </div>

      <div class="row">
        <label id="endTimeLbl">End time: </label>
        <input id="endTimeInput" readonly />
      </div>

      <div class="row">
        <label id="expirationLbl">Expires: </label>
        <input id="expirationInput" readonly />
      </div>
      <div class="row">
        <label id="safetyMargin">Safety Margin: </label>
        <input id="safetyMarginInput" readonly />
      </div>
      <div class="row">
        <label id="duration">Duration: </label>
        <input id="durationInput" readonly />
      </div>
      <div class="row">
        <label id="autoRefreshLbl">Auto Refresh: </label>
        <input id="autoRefreshInput" readonly />
      </div>
    </div>
    <div id="map"></div>

    <div id="basemaps-wrapper">
      <select id="basemaps"></select>
    </div>

    <script type="module">
      let style = null
      let basemapSession = null

      const accessToken = apiKey

      const updateSessionInfo = () => {
        const sessionInfoElement = document.getElementById("currentSessionInfo")
        document.getElementById("styleFamilyInput").value =
          basemapSession.styleFamily
        document.getElementById("startTimeInput").value =
          basemapSession._session.startTime.toLocaleString()
        document.getElementById("endTimeInput").value =
          basemapSession._session.endTime.toLocaleString()
        document.getElementById("durationInput").value =
          `${basemapSession._session.duration} seconds`
        document.getElementById("autoRefreshInput").value =
          basemapSession._session.autoRefresh.toString()
        document.getElementById("safetyMarginInput").value =
          `${basemapSession._session.safetyMargin} seconds`
        document.getElementById("expirationInput").value =
          basemapSession.expires.toLocaleString()
      }

      const updateStyle = async (e) => {
        const selectedItem = e.currentTarget.selectedOptions[0].value
        const selectedStyleFamily = selectedItem.split("/")[0]

        if (basemapSession.styleFamily !== selectedStyleFamily) {
          basemapSession = await getNewSession(selectedStyleFamily)
          style.setSession(basemapSession)
        }
        style.setStyle(selectedItem)
        updateSessionInfo()
      }

      const setBasemapDropdown = async () => {
        const basemapsSelectElement = document.getElementById("basemaps")
        basemapsSelectElement.addEventListener("change", updateStyle)

        const styleResponse = await maplibreArcGIS.BasemapStyle.getSelf()
        styleResponse.styles
          .filter((style) => !style.deprecated)
          .forEach((style) => {
            const option = document.createElement("option")
            option.value = style.path
            option.textContent = style.name
            basemapsSelectElement.appendChild(option)
          })

        return basemapsSelectElement.options[0].value
      }

      const getNewSession = async (styleFamily) => {
        // Start a session with the ArcGIS Basemap Style API
        // const newSession = new maplibreArcGIS.BasemapStyleSession() // for autorefresh logic
        const newSession = await maplibreArcGIS.BasemapStyleSession.start({
          authentication: accessToken,
          duration: 30,
          autoRefresh: false,
          styleFamily: styleFamily,
        })

        newSession.on("BasemapStyleSessionError", (error) => {
          console.error("Session error:", error)
          //alert("Session error")
        })

        newSession.on("BasemapStyleSessionExpired", () => {
          console.log("Session expired")
          updateSessionInfo()
          basemapSession.refreshSession()
        })

        newSession.on("BasemapStyleSessionRefreshed", () => {
          console.log("Session refreshed")
          updateSessionInfo()
          //alert("Session refreshed")
        })

        return newSession
      }

      const initialBasemap = await setBasemapDropdown()

      //**** CURRENT Implementation
      basemapSession = new maplibreArcGIS.BasemapStyleSession({
        token: accessToken,
        safetyMargin: 0,
        duration: 60,
        autoRefresh: false,
      })

      style = new maplibreArcGIS.BasemapStyle(initialBasemap, {
        session: basemapSession,
      })

      const map = new maplibregl.Map({
        container: "map", // the id of the div element
        zoom: 12, // starting zoom
        center: [-118.805, 34.027], // starting location [longitude, latitude]
      })
      map.on("load", () => {
        //this won't fire until style.applyStyleTo runs`
        console.log("Map loaded")
      })
      map.on("styledata", () => {
        console.log("Style data loaded")
        updateSessionInfo()
      })
      map.on("styledataerror", () => {
        console.log("Style data error")
      })
      // style is going to start the session if it is not already started
      // add state management to session
      // optionally manually start session if not started
      //await basemapSession.startSession()
      try {
        style.applyStyleTo(map) //1. start session if not started 2. fetch style and insert tokens into style
      } catch (error) {
        // you need a valid session to apply style
        // await basemapSession.start()
        // style.applyStyleTo(map)
        console.error(error)
      }

      // autoRefresh=false listen for events on session object to manually refresh
      basemapSession.on("BasemapStyleSessionExpired", () => {
        console.log("Client: Session expired")
        basemapSession.refresh().then(() => {
          console.log("BasemapSession started...")
          updateSessionInfo()
        }) // gets a new session

        // style.setSession(newSession)
      })
      basemapSession.on("BasemapStyleSessionRefreshed", () => {
        console.log("Client: Session refreshed")
        updateSessionInfo()
      })
      basemapSession.on("BasemapStyleSessionError", () => {
        console.log("Client: Session error")
      })

      // basemapSession.autoRefresh(map) //starts the session and attaches the map to the session

      // updateSessionInfo()

      //**** OPTION 1 - synchronous default parameters
      // basemapSession = new maplibreArcGIS.BasemapStyleSession({
      //   authentication: accessToken,
      // })
      // basemapStyle = new maplibreArcGIS.BasemapStyle(initialBasemap, {
      //   authentication: basemapSession,
      // })
      // const map = new maplibregl.Map({
      //   container: "map", // the id of the div element
      //   style: basemapStyle.styleUrl,
      //   zoom: 12, // starting zoom
      //   center: [-118.805, 34.027], // starting location [longitude, latitude]
      //   transformRequest: function(url, resourceType) {
      //     if (basemapStyle.shouldTransformRequest(){

      //     })

      //   },
      // })
      // basemapSession.autoRefresh(map)
    </script>
  </body>
</html>
