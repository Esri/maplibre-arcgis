<!--

To run this demo, you need to replace 'YOUR_ACCESS_TOKEN' with an access token from ArcGIS that has the correct privileges.

To get started, sign up for a free ArcGIS Location Platform account or a free trial of ArcGIS Online and create developer credentials.

https://developers.arcgis.com/documentation/security-and-authentication/get-started/

-->
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>MapLibre GL JS Tutorials: Change the basemap style</title>

    <style>
      html,
      body,
      #map {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 14px;
        color: #323232;
      }

      #basemaps-wrapper {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0);
      }

      #basemaps {
        font-size: 16px;
        padding: 4px 8px;
      }

      #currentSessionInfo {
        position: absolute;
        top: 20px;
        left: 20px;

        z-index: 1001;
        background: rgba(255, 255, 255, 0.75);
        display: flex;
        flex-direction: column;
        padding: 10px;
      }

      .row {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
    </style>
    <!-- Load MapLibre GL JS from CDN -->
    <script src="https://unpkg.com/maplibre-gl@5.6.1/dist/maplibre-gl.js"></script>
    <link
      href="https://unpkg.com/maplibre-gl@5.6.1/dist/maplibre-gl.css"
      rel="stylesheet"
    />

    <!-- Load MapLibre ArcGIS from CDN -->
    <!-- <script src="https://basemap-sessions-preview.gha.afd.arcgis.com/maplibre-gl-js//maplibre-arcgis/maplibre-arcgis-debug.js"></script> -->

    <script src="../dist/maplibre-arcgis-debug.js"></script>
    <script src="../debug/apikey.js"></script>
  </head>

  <body>
    <div id="currentSessionInfo">
      <h4>Current Session:</h4>
      <div class="row">
        <label id="styleFamilyLbl">Style family: </label>
        <input id="styleFamilyInput" readonly />
      </div>
      <div class="row">
        <label id="startTimeLbl">Start time: </label>
        <input id="startTimeInput" readonly />
      </div>

      <div class="row">
        <label id="endTimeLbl">End time: </label>
        <input id="endTimeInput" readonly />
      </div>

      <div class="row">
        <label id="expirationLbl">Expires: </label>
        <input id="expirationInput" readonly />
      </div>
      <div class="row">
        <label id="safetyMargin">Safety Margin: </label>
        <input id="safetyMarginInput" readonly />
      </div>
      <div class="row">
        <label id="duration">Duration: </label>
        <input id="durationInput" readonly />
      </div>
      <div class="row">
        <label id="autoRefreshLbl">Auto Refresh: </label>
        <input id="autoRefreshInput" readonly />
      </div>
    </div>
    <div id="map"></div>

    <div id="basemaps-wrapper">
      <select id="basemaps"></select>
    </div>

    <script type="module">
      let style = null
      let basemapSession = null

      const accessToken = sessionKey2;

      const updateSessionInfo = () => {
        const sessionInfoElement = document.getElementById("currentSessionInfo")
        document.getElementById("styleFamilyInput").value =
          basemapSession.styleFamily
        document.getElementById("startTimeInput").value =
          basemapSession._session.startTime.toLocaleString()
        document.getElementById("endTimeInput").value =
          basemapSession._session.endTime.toLocaleString()
        document.getElementById("durationInput").value =
          `${basemapSession._session.duration} seconds`
        document.getElementById("autoRefreshInput").value =
          basemapSession._session.autoRefresh.toString()
        document.getElementById("safetyMarginInput").value =
          `${basemapSession._session.safetyMargin} seconds`
        document.getElementById("expirationInput").value =
          basemapSession.expires.toLocaleString()
      }

      const updateStyle = async (e) => {
        const selectedItem = e.currentTarget.selectedOptions[0].value
        const selectedStyleFamily = selectedItem.split("/")[0]

        if (basemapSession.styleFamily !== selectedStyleFamily) {
          basemapSession = await getNewSession(selectedStyleFamily)
          style.setSession(basemapSession)
        }
        style.updateStyle(selectedItem);
        updateSessionInfo()
      }

      const setBasemapDropdown = async () => {
        const basemapsSelectElement = document.getElementById("basemaps")
        basemapsSelectElement.addEventListener("change", updateStyle)

        const styleResponse = await maplibreArcGIS.BasemapStyle.getSelf()
        styleResponse.styles
          .filter((style) => !style.deprecated)
          .forEach((style) => {
            const option = document.createElement("option")
            option.value = style.path
            option.textContent = style.name
            basemapsSelectElement.appendChild(option)
          })

        return basemapsSelectElement.options[0].value
      }

      const initialBasemap = await setBasemapDropdown()

      basemapSession = new maplibreArcGIS.BasemapSession({
        token: accessToken,
        safetyMargin: 0,
        duration: 60,
        autoRefresh: false,
      })

      const map = new maplibregl.Map({
        container: "map", // the id of the div element
        zoom: 12, // starting zoom
        center: [-118.805, 34.027], // starting location [longitude, latitude]
        attributionControl: false
      })
      style = maplibreArcGIS.BasemapStyle.applyStyle(map,{
        style: initialBasemap,
        session: basemapSession,
      })

      /**** Event handlers *****/
      map.on("load", () => {
        //this won't fire until style.applyStyleTo runs`
        console.log("Map loaded")
      })

      map.on("styledata", () => {
        console.log("Style data loaded")
        updateSessionInfo()
      })

      map.on("styledataerror", () => {
        console.log("Style data error")
      })

      basemapSession.on("BasemapSessionExpired", () => {
        console.log("Client: Session expired")
        basemapSession.refresh().then(() => {
          console.log("BasemapSession started...")
          updateSessionInfo()
        }) // gets a new session
      })

      basemapSession.on("BasemapSessionRefreshed", () => {
        console.log("Client: Session refreshed")
        updateSessionInfo()
      })

      basemapSession.on("BasemapSessionError", () => {
        console.log("Client: Session error")
      })
    </script>
  </body>
</html>
