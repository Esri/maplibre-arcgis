<!doctype html>
<html>
  <head>
    <style>
      html,
      body,
      #map {
        padding: 0;
        margin: 0;
        width: 100%;
        height: 100%;
      }
    </style>
    <script src="https://unpkg.com/maplibre-gl@^5.6.1/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@^5.6.1/dist/maplibre-gl.css" rel="stylesheet" />
    <!-- <link href="../node_modules/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="../node_modules/maplibre-gl/dist/maplibre-gl.js"></script> -->
    <!-- Maplibre ArcGIS -->
    <script src="../dist/maplibre-arcgis-debug.js"></script>
  </head>
  <body>
    <dialog id="usageTypeDialog">
      <form>
        <p id="dialogTitle">Your session has expired, create a new session or switch to tile based usage.</p>

        <label
          >Usage type:
          <select id="usageSelect">
            <option value="tiles">Tiles</option>
            <option value="session">Sessions</option>
          </select></label
        >
        <button id="okButton" type="button">OK</button>
      </form>
    </dialog>
    <div id="map"></div>
    <script src="../debug/apikey.js"></script>
    <script type="module">
      const sessionDuration = 30 // seconds
      let currentToken = null

      const usageTypeDialog = document.getElementById("usageTypeDialog")

      const map = new maplibregl.Map({
        container: "map", // the id of the div element
        zoom: 14, // starting zoom
        center: [-117.805, 34.027], // starting location
      })

      map.on("error", (err) => {
        console.log(`Map error: ${err.error.message}`)
        //updateSession()
      })

      const setUsageType = () => {
        usageTypeDialog.showModal()
      }

      const updateTiles = (oldToken, newToken) => {
        console.log("\t updating map with new session...")

        // replace token in the styles tiles with the new session token
        for (const s of Object.keys(map.style.sourceCaches)) {
          console.log(`\t checking source ${s}...`)
          const source = map.getSource(s)
          // skip if we can't find the source or the source doesn't have tiles
          if (!source || !source.tiles) {
            console.log(`\t skipping ${s}...`)
            return
          }

          // Skip if the source doesn't have tiles that include the old token
          if (!source.tiles.some((tileUrl) => tileUrl.includes(oldToken))) {
            console.log(`\t old token not found in ${tileUrl}, skipping.`)
            return
          }

          const newTiles = source.tiles.map((tile) => {
            console.log(`\t replacing session toking in ${tile}...`)
            return tile.includes(oldToken) ? tile.replace(oldToken, newToken) : tile
          })

          console.log("\t updating tiles...")
          source.setTiles(newTiles)
        }

        // replace the token in the glyph url, ensuring fonts continue loading
        const glyphs = map.getGlyphs()
        if (glyphs.includes(oldToken)) {
          console.log("\t replacing glyph tokens...")
          map.setGlyphs(glyphs.replace(oldToken, newToken))
        }

        const sprites = map.getSprite()
        for (const sprite of sprites) {
          if (sprite.url.includes(oldToken)) {
            map.setSprite(sprite.url.replace(oldToken, newToken))
          }
        }

        // map.triggerRepaint()
      }

      const getSession = async () => {
        const getBasemapSession = async (accessToken) => {
          console.log("requesting new session...")
          let session = null
          const params = new URLSearchParams({
            styleFamily: "arcgis",
            durationSeconds: sessionDuration,
          })

          try {
            const response = await fetch(`https://basemapstylesdev-api.arcgis.com/arcgis/rest/services/styles/v2/sessions/start?${params.toString()}`, {
              method: "GET",
              headers: { Authorization: `Bearer ${accessToken}` },
            })

            session = await response.json()
            console.log(`new session acquired: ${JSON.stringify(session, null, 2)}`)
          } catch (error) {
            console.log(`Failed to create session token: ${error}`)
          }

          return session
        }

        const session = await getBasemapSession(apiKey)

        setTimeout(setUsageType, 25000)

        currentToken = session.sessionToken

        return session
      }

      await getSession()
      // Also supports item IDs for custom basemap styles
      // Try: '9d94a890b76a417cad8a748df4f97336'
      const style = new maplibreArcGIS.BasemapStyle("arcgis/navigation", {
        accessToken: currentToken,
        // usageModel: { type: "sessions", duration: 30, autoRefresh: false, refreshFunction: () => {} }, // infer family
        // usageModel: { type: "tiles" }, //defaut?},
        // baseMapSessions: bool || object,
      })
      style.applyStyleTo(map)
      // style.setSessionToken() // update a session?

      // style.getBasemapSession() //returns arcgis-rest-js object

      // style.on("sessionExipired", (evt) => {
      //   // what's returned here?
      //   const newSession = style.getNewSession() // gets new session and updates tiles?
      //   style.setSessionToken(newSession)
      //   // style.updateSessionToken()
      // })

      const closeButton = document.getElementById("okButton")
      closeButton.addEventListener("click", (e) => {
        const usage = document.getElementById("usageSelect").value
        usageTypeDialog.close(usage)
      })

      usageTypeDialog.addEventListener("close", async (e) => {
        console.log("dialog closed")
        console.log("returnValue:", e.returnValue)

        let type = "access"
        let newToken = apiKey

        if (e.returnValue === "session") {
          console.log("Usage type is session")
          type = "session"

          const newSession = await getSession()
          newToken = newSession.sessionToken
        }

        console.log(`usage type set to: ${type}, with token: ${newToken}`)

        console.log(`${currentToken === newToken}`)
        updateTiles(currentToken, newToken)

        currentToken = newToken
      })
    </script>
  </body>
</html>
